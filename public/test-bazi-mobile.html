<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>스마트폰 명리학 테스트</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a1a;
            color: white;
        }
        .test-section {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }
        .log {
            background: #000;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .error {
            color: #ff6b6b;
        }
        .success {
            color: #51cf66;
        }
        .info {
            color: #74c0fc;
        }
    </style>
</head>
<body>
    <h1>📱 스마트폰 명리학 분석 테스트</h1>
    
    <div class="test-section">
        <h3>🔍 현재 상태 확인</h3>
        <button onclick="checkCurrentState()">현재 상태 확인</button>
        <button onclick="checkLocalStorage()">localStorage 확인</button>
        <button onclick="checkUserInfo()">사용자 정보 확인</button>
        <div id="currentState" class="log"></div>
    </div>
    
    <div class="test-section">
        <h3>🚀 명리학 분석 테스트</h3>
        <button onclick="testBaziAnalysis()">명리학 분석 실행</button>
        <button onclick="testChangeSection()">명리학 섹션 이동</button>
        <div id="baziTest" class="log"></div>
    </div>
    
    <div class="test-section">
        <h3>📊 실시간 로그</h3>
        <button onclick="clearLogs()">로그 지우기</button>
        <div id="realtimeLog" class="log"></div>
    </div>

    <script>
        // 로그 함수
        function log(message, type = 'info') {
            const logDiv = document.getElementById('realtimeLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // 현재 상태 확인
        function checkCurrentState() {
            const stateDiv = document.getElementById('currentState');
            stateDiv.innerHTML = '';
            
            log('=== 현재 상태 확인 시작 ===', 'info');
            
            // 화면 크기
            const screenInfo = {
                width: window.innerWidth,
                height: window.innerHeight,
                isMobile: window.innerWidth <= 768
            };
            log(`화면 크기: ${screenInfo.width}x${screenInfo.height}, 모바일: ${screenInfo.isMobile}`, 'info');
            
            // localStorage
            const authToken = localStorage.getItem('authToken');
            const currentUser = localStorage.getItem('currentUser');
            log(`인증 토큰: ${authToken ? '있음' : '없음'}`, authToken ? 'success' : 'error');
            log(`사용자 정보: ${currentUser ? '있음' : '없음'}`, currentUser ? 'success' : 'error');
            
            // 현재 URL
            log(`현재 URL: ${window.location.href}`, 'info');
            
            // DOM 요소 확인
            const baziSection = document.getElementById('bazi');
            const baziResult = document.getElementById('baziResult');
            const myBaziInfo = document.getElementById('myBaziInfo');
            
            log(`명리학 섹션: ${baziSection ? '찾음' : '없음'}`, baziSection ? 'success' : 'error');
            log(`결과 컨테이너: ${baziResult ? '찾음' : '없음'}`, baziResult ? 'success' : 'error');
            log(`사용자 정보 컨테이너: ${myBaziInfo ? '찾음' : '없음'}`, myBaziInfo ? 'success' : 'error');
            
            // 상태 표시
            stateDiv.innerHTML = `
                <div><strong>화면 크기:</strong> ${screenInfo.width}x${screenInfo.height} (모바일: ${screenInfo.isMobile})</div>
                <div><strong>인증 토큰:</strong> ${authToken ? '✅ 있음' : '❌ 없음'}</div>
                <div><strong>사용자 정보:</strong> ${currentUser ? '✅ 있음' : '❌ 없음'}</div>
                <div><strong>명리학 섹션:</strong> ${baziSection ? '✅ 찾음' : '❌ 없음'}</div>
                <div><strong>결과 컨테이너:</strong> ${baziResult ? '✅ 찾음' : '❌ 없음'}</div>
                <div><strong>사용자 정보 컨테이너:</strong> ${myBaziInfo ? '✅ 찾음' : '❌ 없음'}</div>
            `;
        }

        // localStorage 확인
        function checkLocalStorage() {
            log('=== localStorage 확인 ===', 'info');
            
            const authToken = localStorage.getItem('authToken');
            const currentUser = localStorage.getItem('currentUser');
            
            if (authToken) {
                log('인증 토큰 발견:', 'success');
                try {
                    const tokenParts = authToken.split('.');
                    if (tokenParts.length === 3) {
                        const payload = JSON.parse(atob(tokenParts[1]));
                        log(`토큰 페이로드: ${JSON.stringify(payload, null, 2)}`, 'info');
                    }
                } catch (e) {
                    log(`토큰 파싱 오류: ${e.message}`, 'error');
                }
            } else {
                log('인증 토큰 없음', 'error');
            }
            
            if (currentUser) {
                log('사용자 정보 발견:', 'success');
                try {
                    const user = JSON.parse(currentUser);
                    log(`사용자 정보: ${JSON.stringify(user, null, 2)}`, 'info');
                } catch (e) {
                    log(`사용자 정보 파싱 오류: ${e.message}`, 'error');
                }
            } else {
                log('사용자 정보 없음', 'error');
            }
        }

        // 사용자 정보 확인
        function checkUserInfo() {
            log('=== 사용자 정보 확인 ===', 'info');
            
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                log('사용자 정보가 없습니다.', 'error');
                return;
            }
            
            try {
                const user = JSON.parse(currentUser);
                log('사용자 정보 파싱 성공:', 'success');
                
                const birthInfo = {
                    birthYear: user.birthYear || user.birth_year,
                    birthMonth: user.birthMonth || user.birth_month,
                    birthDay: user.birthDay || user.birth_day,
                    birthHour: user.birthHour || user.birth_hour
                };
                
                log(`생년월일 정보: ${JSON.stringify(birthInfo, null, 2)}`, 'info');
                
                const hasCompleteInfo = birthInfo.birthYear && birthInfo.birthMonth && birthInfo.birthDay;
                log(`완전한 생년월일 정보: ${hasCompleteInfo ? '✅ 있음' : '❌ 없음'}`, hasCompleteInfo ? 'success' : 'error');
                
            } catch (e) {
                log(`사용자 정보 파싱 오류: ${e.message}`, 'error');
            }
        }

        // 명리학 분석 테스트
        async function testBaziAnalysis() {
            log('=== 명리학 분석 테스트 시작 ===', 'info');
            
            const currentUser = localStorage.getItem('currentUser');
            const authToken = localStorage.getItem('authToken');
            
            if (!currentUser || !authToken) {
                log('사용자 정보 또는 인증 토큰이 없습니다.', 'error');
                return;
            }
            
            try {
                const user = JSON.parse(currentUser);
                log('사용자 정보 로드 성공:', 'success');
                
                const birthYear = user.birthYear || user.birth_year;
                const birthMonth = user.birthMonth || user.birth_month;
                const birthDay = user.birthDay || user.birth_day;
                const birthHour = user.birthHour || user.birth_hour;
                
                if (!birthYear || !birthMonth || !birthDay) {
                    log('생년월일 정보가 불완전합니다.', 'error');
                    return;
                }
                
                log(`분석할 생년월일: ${birthYear}년 ${birthMonth}월 ${birthDay}일 ${birthHour || 0}시`, 'info');
                
                // API 호출 테스트
                const requestData = {
                    birth_year: parseInt(birthYear),
                    birth_month: parseInt(birthMonth),
                    birth_day: parseInt(birthDay),
                    birth_hour: parseInt(birthHour) || 12
                };
                
                log(`API 요청 데이터: ${JSON.stringify(requestData, null, 2)}`, 'info');
                
                const response = await fetch('http://localhost:3000/api/bazi', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(requestData)
                });
                
                log(`API 응답 상태: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const result = await response.json();
                    log('API 응답 성공:', 'success');
                    log(`응답 데이터: ${JSON.stringify(result, null, 2)}`, 'info');
                } else {
                    const errorText = await response.text();
                    log(`API 오류: ${errorText}`, 'error');
                }
                
            } catch (e) {
                log(`분석 테스트 오류: ${e.message}`, 'error');
            }
        }

        // 명리학 섹션 이동 테스트
        function testChangeSection() {
            log('=== 명리학 섹션 이동 테스트 ===', 'info');
            
            // changeSection 함수가 있는지 확인
            if (typeof window.changeSection === 'function') {
                log('changeSection 함수 발견:', 'success');
                try {
                    window.changeSection('bazi');
                    log('changeSection 호출 완료', 'success');
                } catch (e) {
                    log(`changeSection 호출 오류: ${e.message}`, 'error');
                }
            } else {
                log('changeSection 함수를 찾을 수 없습니다.', 'error');
            }
        }

        // 로그 지우기
        function clearLogs() {
            document.getElementById('realtimeLog').innerHTML = '';
            log('로그가 지워졌습니다.', 'info');
        }

        // 페이지 로드 시 초기 상태 확인
        window.addEventListener('load', () => {
            log('스마트폰 명리학 테스트 페이지 로드됨', 'success');
            checkCurrentState();
        });
    </script>
</body>
</html>



